class t{constructor(t){this.ctx=t}async load(t){return await this.ctx.http.fetch({method:"GET",url:`[WF]${t}`})}async loadSettings(t){if(t){this.ctx.config.addSetting("[settingsUrl]",t);const e=await this.ctx.http.fetch({method:"GET",url:t});Object.keys(e).forEach((t=>this.ctx.config.addSetting(t,e[t])))}}}class e{constructor(){this.settings=new Map}getSetting(t){return this.settings.get(t)}addSetting(t,e){-1===t.indexOf("[")&&(t=`[${t}]`),this.settings.set(t,e)}}class s{constructor(t){this.config=t}async fetch(t){var e;const s=await fetch(this.resolveSetting(t.url),this.getConfig(t));if(s.status>=400){const e=await s.json();throw s.status>=401&&console.dir({type:"UN_AUTHORIZED",metadata:{endpoint:t,error:e}}),{code:s.status,message:s.statusText,error:e}}return(null==(e=s.headers.get("content-type"))?void 0:e.indexOf("json"))?await s.json():await s.text()}getConfig(t){return{method:t.method,mode:"cors",headers:Object.apply({"Content-Type":"application/json"},t.headers),redirect:"follow",referrer:"no-referrer",body:t.body?JSON.stringify(t.body):null}}resolveSetting(t,e=0){if(e>2)return t;const s=t.match(/\[[\w|_]+\]/g);if(!s)return t;let i=s.reduce(this.replace.bind(this),t);return i.indexOf("[")>-1&&(i=this.resolveSetting(i,e++)),i}replace(t,e){let s=this.config.getSetting(e);return s&&s.indexOf("[SELF]")>-1?s.replace("[SELF]",t.replace(e,"")):t.replace(e,s)}}class i{constructor(){this.type=""}async execute(t){}async exit(t){return!0}}class n extends i{constructor(t){super(),this.activity=t,this.type="not-found-activity"}async execute(t){console.error(`The ${this.activity} was not found!!`)}}class a extends i{constructor(){super(...arguments),this.type="page-activity",this.controls=[]}async execute(t){t.container.innerHTML="",this.controls.forEach(this.createElement.bind(this,t,t.container))}createElement(t,e,s){var i;const n=Object.assign(document.createElement(s.tag),s,{ctx:t});this.bindEvent(t,n,s),e.appendChild(n),null==(i=s.controls)||i.forEach(this.createElement.bind(this,t,n))}bindEvent(t,e,s){Object.keys(s).filter((t=>t.startsWith("on"))).forEach((i=>e[i.toLowerCase()]=e=>{e.preventDefault(),new Function("ctx",s[i])(t)}))}}class r extends HTMLElement{constructor(){super(...arguments),this.config=new e,this.http=new s(this.config),this.activities=[new a],this.isInitialized=!1,this.wfLoader=new t(this)}static get observedAttributes(){return["process"]}async connectedCallback(){this.createContainer(),await this.wfLoader.loadSettings(this.getAttribute("url"));const t=this.getAttribute("process");t&&await this.goto("start",t),this.isInitialized=!0}attributeChangedCallback(t,e,s){this.isInitialized&&e!=s&&"process"==t&&s&&this.goto("start",s)}async goto(t,e=""){await this.loadProcess(e),await this.loadActivity(t)}async loadProcess(t){t.length>0&&(this.wf=await this.wfLoader.load(t))}async loadActivity(t){var e,s,i;if(void 0!==this.act&&!this.act.exit(this))return;const a=null==(s=null==(e=this.wf)?void 0:e.activities)?void 0:s.find((e=>e.name===t)),r=null!=(i=this.activities.find((t=>t.type===(null==a?void 0:a.type))))?i:new n(t);this.act=Object.assign(r,a),await this.act.execute(this)}createContainer(){const t=this.useShadow()?this.attachShadow({mode:"open"}):this;t.innerHTML=`<style>@import '${this.getAttribute("styleUrl")}'</style>`,this.container=document.createElement("div"),t.appendChild(this.container)}useShadow(){return!("false"===this.getAttribute("shadow"))}}customElements.define("sirius-wf",r);
